<!doctype html> <html class=no-js lang=en> <head> <title>LibSourcey Using Libuv Networking Layer</title> <meta charset=utf-8 /> <meta name=viewport content="width=device-width, initial-scale=1.0"/> <meta name=google-site-verification content=lC7-hHwqtiRqo7YTHc1fJ6t8ie-Hs7J4o5u3XRIF9Vw /> <link rel=alternate type="application/atom+xml" title="Atom Feed" href="/feed.xml"/> <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-836728-7', 'sourcey.com');
      ga('send', 'pageview');
    </script> </head> <body class="blog libsourcey-using-libuv-networking-layer libsourcey-using-libuv-networking-layer_index"> <nav class=top-bar data-topbar=""> <div id=social> <a href="https://plus.google.com/+SourceyDevel"><i class="fi-social-google-plus large"></i></a> <a href="https://facebook.com/sourceydevel"><i class="fi-social-facebook large"></i></a> <a href="https://twitter.com/sourceydevel"><i class="fi-social-twitter large"></i></a> <a href="https://github.com/sourcey"><i class="fi-social-github large"></i></a> </div> <ul class=title-area> <li class=name></li> <li class="toggle-topbar menu-icon"><a href="" class=left></a></li> </ul> <section class=top-bar-section style="left: 0%;"> <ul class=left> <li class="has-dropdown not-click"><a href="/">Menu</a> <ul class=dropdown><li class="title back js-generated"><h5><a href="javascript:void(0)">Back</a></h5></li> <li><label>Wicked</label></li> <li class="has-dropdown not-click"><a href="/#projects">Projects</a> <ul class=dropdown><li class="title back js-generated"><h5><a href="javascript:void(0)">Back</a></h5></li> <li><label>Projects</label></li> <li><a href="/libsourcey">LibSourcey</a></li> <li><a href="/anionu">Anionu</a></li> <li><a href="/symple">Symple</a></li> <li><a href="/mesh">Mesh</a></li> <li><a href="/pacm">Pacm</a></li> </ul> </li> <li class=divider></li> <li><a href="/#blog">Blog</a></li> <li><a href="/archives">Archives</a></li> <li><a href="/feed.xml">Feed</a></li> <li class=divider></li> <li><a href="mailto:hello@sourcey.com">Contact</a></li> </ul> </li> <li class=divider></li> </ul> </section></nav> <header id=header> <h1 id=logo> <a title=Sourcey rel=home href="//sourcey.com"><img height=150 width=150 title=Sourcey alt=Sourcey src="/images/logo-250.png"/></a> </h1> </header> <div id=main role=main> <div id=rotate-article> <a class=next href="/libuv-cpp-wrappers/">next article &rarr;</a> <a class=prev href="/youtube-html5-embed-from-url-with-php/">&larr; previous article</a> </div> <h1 id=libsourcey-using-libuv-networking-layer>LibSourcey Using Libuv Networking Layer</h1> <p>Node.js does a brilliant job of enabling developers to quickly and easily deploy high performance server stacks in the cloud using good old JavaScript.</p> <p>Most developers who use <a href="//www.joyent.com/" title="High-performance Cloud Computing" target=_blank>Joyent's</a> <a href="//nodejs.org/" title=NodeJS target=_blank>Node.js</a>, also know about <a href="https://github.com/joyent/libuv" title="Cross-platform asychronous I/O">libuv</a>, the underlying cross platform asynchronous I/O library which powers Node.js's awesomeness.</p> <p>Once we began developing mission critical server deployments, such as our <a href="https://tools.ietf.org/html/rfc5245" title="Interactive Connectivity Establishment" target=_blank>ICE </a>stack (TURN/STUN server), HTTP server and <a href="//sourcey.com/symple" title="Messaging Made Symple" target=_blank>Symple</a> messaging, our old multi-thread code design just wouldn't cut it.</p> <p><a href="//sourcey.com/libsourcey" title="C++ Networking Evolved" target=_blank>LibSourcey </a>started it's life using Poco C++ libraries to abstract cross platform details. Poco is very well designed architecture, and it's clean coding style make for a brilliant library, but it's clearly not meant for high-performance networking. This is evident in the use of a thread-per-connection model in the HTTP stack implementations. </p> <p>Another niggle was the overuse or private methods and members which makes Poco almost impossible to extend in many basic scenarios. Some things about Poco's open source libraries just didn't seem as open as they could be, which is why we turned to C++11 and libuv.</p> <p>The first thing that's great about working with libuv is that synchronization is no longer such an issue. Since the event loop runs in a single thread, and it forced us to refactor the way classes and models interacted to facilitate single-thread synchronization. Rather than blocking the thread, now we just wait for a callback on the next event loop iteration. The result was an easy 80% decrease in the use of synchronization primitives, and overall better code design. Nice!</p> <p>One important consideration with this evented IO model is that the packet must be handled, and event loop freed as soon as possible in order to maintain good performance. LibSourcey uses the PacketStream class to handle all heavy asynchronous data processing, such as video capture and media encoding and the like. The <a href="//sourcey.com/libsourcey-packetstream-api/" title="LibSourcey PacketStream API" target=_blank>PacketStream </a>receives packets from any thread and passes them to arbitrary PacketProcessor implementations which process the data and synchronize output with the event loop - usually for broadcasting via the socket.</p> <p>If you want to save your sanity then stop writing multi-thread code, you'll see! Stick to a thread-per-core model if you can, especially for networking - your code will be better, faster, and easier to debug. There's a lot more to talk about here, but that's a post for another day. Any questions, just drop me a line!</p> <ul class=social-buttons> <li> <a href="//twitter.com/share" class="socialite twitter-share" data-text="LibSourcey Using Libuv Networking Layer" data-url="http://sourcey.com/libsourcey-using-libuv-networking-layer/" data-count=vertical rel=nofollow target=_blank><span class=vhidden>Share on Twitter</span></a> </li> <li> <a href="https://plus.google.com/share?url=http://sourcey.com/libsourcey-using-libuv-networking-layer/" class="socialite googleplus-one" data-size=tall data-href="//sourcey.com/libsourcey-using-libuv-networking-layer/" rel=nofollow target=_blank><span class=vhidden>Share on Google+</span></a> </li> <li> <a href="//www.facebook.com/sharer.php?u=http://sourcey.com/libsourcey-using-libuv-networking-layer/&amp;t=LibSourcey Using Libuv Networking Layer" class="socialite facebook-like" data-href="http://sourcey.com/libsourcey-using-libuv-networking-layer/" data-send=false data-layout=box_count data-width=60 data-show-faces=false rel=nofollow target=_blank><span class=vhidden>Share on Facebook</span></a> </li> <li> <a href="//www.linkedin.com/shareArticle?mini=true&amp;url=http://sourcey.com/libsourcey-using-libuv-networking-layer/&amp;title=LibSourcey Using Libuv Networking Layer" class="socialite linkedin-share" data-url="http://sourcey.com/libsourcey-using-libuv-networking-layer/" data-counter=top rel=nofollow target=_blank><span class=vhidden>Share on LinkedIn</span></a> </li> </ul> <div class=meta> Posted on <time class=updated datetime="Feb 10 2014">Feb 10 2014</time> by <a rel="author external" href="https://plus.google.com/+KamLow">Kam Low</a> . Tagged: c, libsourcey, libuv, node.js, programming. </div> <div id=disqus_thread></div> <script>
          /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
          var disqus_shortname = 'sourcey'; // required: replace example with your forum shortname

          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
              var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
              dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
              (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
      </script> <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript" rel=nofollow>comments powered by Disqus.</a></noscript> <a href="//disqus.com" rel=nofollow class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a> </div> <footer id=footer> <p> As with all business minded artists, we have fought the inevitable battle of conformity vs expression, and have emerged victorious with sanity intact to plunder the digiverse in search of new and interesting challenges. For more information, or a quote, drop us an email and tell us what you're working on. </p> <p> &copy;2014 Sourcey <p> </footer> </body> </html> <link href="/stylesheets/app.css" media=screen rel=stylesheet /><script src="/javascripts/all.js"></script>