<!doctype html> <html class=no-js lang=en> <head> <title>Precompiling Assets for Large Rails Deployments with Capistrano</title> <meta charset=utf-8 /> <meta name=viewport content="width=device-width, initial-scale=1.0"/> <meta name=google-site-verification content=lC7-hHwqtiRqo7YTHc1fJ6t8ie-Hs7J4o5u3XRIF9Vw /> <link rel=alternate type="application/atom+xml" title="Atom Feed" href="/feed.xml"/> <link href="/stylesheets/app.css" media=screen rel=stylesheet /> <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-836728-7', 'sourcey.com');
      ga('send', 'pageview');
    </script> </head> <body class="blog precompiling-assets-for-large-rails-deployments-with-capistrano precompiling-assets-for-large-rails-deployments-with-capistrano_index"> <nav class=top-bar data-topbar=""> <div id=social> <a href="https://plus.google.com/+SourceyDevel"><i class="fi-social-google-plus large"></i></a> <a href="https://facebook.com/sourceydevel"><i class="fi-social-facebook large"></i></a> <a href="https://twitter.com/sourceydevel"><i class="fi-social-twitter large"></i></a> <a href="https://github.com/sourcey"><i class="fi-social-github large"></i></a> </div> <ul class=title-area> <li class=name></li> <li class="toggle-topbar menu-icon"><a href="" class=left></a></li> </ul> <section class=top-bar-section style="left: 0%;"> <ul class=left> <li class="has-dropdown not-click"><a href="/">Menu</a> <ul class=dropdown><li class="title back js-generated"><h5><a href="javascript:void(0)">Back</a></h5></li> <li><label>Wicked</label></li> <li class="has-dropdown not-click"><a href="/#projects">Projects</a> <ul class=dropdown><li class="title back js-generated"><h5><a href="javascript:void(0)">Back</a></h5></li> <li><label>Projects</label></li> <li><a href="/libsourcey">LibSourcey</a></li> <li><a href="/anionu">Anionu</a></li> <li><a href="/symple">Symple</a></li> <li><a href="/mesh">Mesh</a></li> <li><a href="/pacm">Pacm</a></li> </ul> </li> <li class=divider></li> <li><a href="/#blog">Blog</a></li> <li><a href="/archives">Archives</a></li> <li><a href="/feed.xml">Feed</a></li> <li class=divider></li> <li><a href="mailto:hello@sourcey.com">Contact</a></li> </ul> </li> <li class=divider></li> </ul> </section></nav> <header id=header> <h1 id=logo> <a title=Sourcey rel=home href="//sourcey.com"><img height=150 width=150 title=Sourcey alt=Sourcey src="/images/logo-250.png"/></a> </h1> </header> <div id=main role=main> <div id=rotate-article> <a class=next href="/agile-peer-code-reviews-with-codebrag/">next article &rarr;</a> <a class=prev href="/darkly-pygments-css-theme/">&larr; previous article</a> </div> <h1 id=precompiling-assets-for-large-rails-deployments-with-capistrano>Precompiling Assets for Large Rails Deployments with Capistrano</h1> <p><img alt=Capistrano title=Capistrano src="/precompiling-assets-for-large-rails-deployments-with-capistrano/capistrano.png"/></p> <p>If you've ever had to deploy a large Rails site using Capistrano, then you're probably aware of how time consuming it is to precompile the assets pipeline on the server-side.</p> <p>This is not really an issue for a small sites with a few images and JavaScripts, but when it starts taking upwards of half an hour to roll out a small or time critical patch you know somethings gotta give!</p> <p>Some people store compiled assets using <code>git</code> in either the master or a separate repository, but that's kind of overkill and it also introduces an extra step. The most efficient way is just to use Capistrano's <code>run_locally</code> command to compile assets on the local machine and then <code>rsync</code> them to the remote server.</p> <p>The following Capistrano script is what we currently use on a Rails 3.2 site, but it should work with other Rails versions too. Stick the following task somewhere in your <code>deploy.rb</code>:</p> <pre class="highlight ruby"><span class="n">namespace</span> <span class="ss">:deploy</span> <span class="k">do</span>
  <span class="n">namespace</span> <span class="ss">:assets</span> <span class="k">do</span>
   <span class="n">desc</span> <span class="s2">"Precompile assets locally and then rsync to deploy server"</span>
    <span class="n">task</span> <span class="ss">:precompile</span><span class="p">,</span> <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:primary</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="p">}</span> <span class="k">do</span>
      <span class="n">run_locally</span> <span class="s2">"bundle exec rake assets:precompile"</span>
      <span class="n">servers</span> <span class="o">=</span> <span class="n">find_servers</span> <span class="ss">:roles</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:app</span><span class="o">]</span><span class="p">,</span> <span class="ss">:except</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:no_release</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="p">}</span>
      <span class="n">servers</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">server</span><span class="o">|</span>
        <span class="n">run_locally</span> <span class="s2">"rsync -av ./public/</span><span class="si">#{</span><span class="n">assets_prefix</span><span class="si">}</span><span class="s2">/ </span><span class="si">#{</span><span class="n">user</span><span class="si">}</span><span class="s2">@</span><span class="si">#{</span><span class="n">server</span><span class="si">}</span><span class="s2">:</span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2">/public/</span><span class="si">#{</span><span class="n">assets_prefix</span><span class="si">}</span><span class="s2">/"</span>
      <span class="k">end</span>
      <span class="n">run_locally</span> <span class="s2">"rm -rf public/</span><span class="si">#{</span><span class="n">assets_prefix</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre> <p class="panel callout radius">If you're a Windows user you can obtain <code>rsync</code> binaries <a href="//www.rsync.net/resources/howto/windows_rsync.html">here</a>. Just add the <code>cwRsync/bin</code> folder to your system path and everything will be peaches.</p> <p>To make sure assets are compiles we need to call <code>deploy:assets:precompile</code> after each deployment. The order in which the task is called is no so critical here since Rails will be compiling assets from the local repository, but just in case anything else fails it would be best to call it after other tasks so we won't have run a costly task for nothing.</p> <p>A good time to run the task is after <code>deploy:finalize_update</code> like so:</p> <pre class="highlight ruby"><span class="n">after</span> <span class="s2">"deploy:finalize_update"</span><span class="p">,</span> <span class="s2">"deploy:assets:precompile"</span>
</pre> <ul class=social-buttons> <li> <a href="//twitter.com/share" class="socialite twitter-share" data-text="Precompiling Assets for Large Rails Deployments with Capistrano" data-url="http://sourcey.com/precompiling-assets-for-large-rails-deployments-with-capistrano/" data-count=vertical rel=nofollow target=_blank><span class=vhidden>Share on Twitter</span></a> </li> <li> <a href="https://plus.google.com/share?url=http://sourcey.com/precompiling-assets-for-large-rails-deployments-with-capistrano/" class="socialite googleplus-one" data-size=tall data-href="//sourcey.com/precompiling-assets-for-large-rails-deployments-with-capistrano/" rel=nofollow target=_blank><span class=vhidden>Share on Google+</span></a> </li> <li> <a href="//www.facebook.com/sharer.php?u=http://sourcey.com/precompiling-assets-for-large-rails-deployments-with-capistrano/&amp;t=Precompiling Assets for Large Rails Deployments with Capistrano" class="socialite facebook-like" data-href="http://sourcey.com/precompiling-assets-for-large-rails-deployments-with-capistrano/" data-send=false data-layout=box_count data-width=60 data-show-faces=false rel=nofollow target=_blank><span class=vhidden>Share on Facebook</span></a> </li> <li> <a href="//www.linkedin.com/shareArticle?mini=true&amp;url=http://sourcey.com/precompiling-assets-for-large-rails-deployments-with-capistrano/&amp;title=Precompiling Assets for Large Rails Deployments with Capistrano" class="socialite linkedin-share" data-url="http://sourcey.com/precompiling-assets-for-large-rails-deployments-with-capistrano/" data-counter=top rel=nofollow target=_blank><span class=vhidden>Share on LinkedIn</span></a> </li> </ul> <div class=meta> Posted on <time class=updated datetime="May 20 2014">May 20 2014</time> by <a rel="author external" href="https://plus.google.com/+KamLow">Kam Low</a> . Tagged: capistrano, rails, rsync. </div> <div id=disqus_thread></div> <script>
          /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
          var disqus_shortname = 'sourcey'; // required: replace example with your forum shortname

          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
              var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
              dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
              (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
      </script> <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript" rel=nofollow>comments powered by Disqus.</a></noscript> <a href="//disqus.com" rel=nofollow class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a> </div> <footer id=footer> <p> As with all business minded artists, we have fought the inevitable battle of conformity vs expression, and have emerged victorious with sanity intact to plunder the digiverse in search of new and interesting challenges. For more information, or a quote, drop us an email and tell us what you're working on. </p> <p> &copy;2014 Sourcey <p> </footer> </body> </html> <script src="/javascripts/all.js"></script>