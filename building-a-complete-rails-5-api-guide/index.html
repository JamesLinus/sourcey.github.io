<!doctype html> <html class=no-js lang=en> <head> <title>Building a Complete Rails 5 API Guide | Sourcey</title> <meta charset=utf-8 /> <meta name=viewport content="width=device-width, initial-scale=1.0"/> <meta name=google-site-verification content=lC7-hHwqtiRqo7YTHc1fJ6t8ie-Hs7J4o5u3XRIF9Vw /> <link rel=alternate type="application/atom+xml" title="Atom Feed" href="/feed.xml"/> <link href="/stylesheets/app.css" media=screen rel=stylesheet /> <script src="/javascripts/all.js"></script> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-836728-7', 'sourcey.com');
      ga('send', 'pageview');
    </script> </head> <body class="article building-a-complete-rails-5-api-guide building-a-complete-rails-5-api-guide_index"> <nav class=top-bar data-topbar=""> <div class=top-bar-inner> <div id=social> <a href="https://github.com/sourcey"><i class=fi-social-github></i></a> <a href="https://twitter.com/sourceydevel"><i class=fi-social-twitter></i></a> <a href="https://plus.google.com/+SourceyDevel"><i class=fi-social-google-plus></i></a> <a href="https://facebook.com/sourceydevel"><i class=fi-social-facebook></i></a> </div> <ul class=title-area> <li class=name></li> <li class="toggle-topbar menu-icon"><a href="#" class=left></a></li> </ul> <section class=top-bar-section style="left: 0%;"> <ul class=left> <li class=home><a href="/">Home</a></li> <li class=has-dropdown><a href="/#projects">Projects</a> <ul class=dropdown><li class="title back js-generated"><h5><a href="javascript:void(0)">Back</a></h5></li> <li> <a href="/libsourcey"><b>LibSourcey</b><small>C++ networking evolved</small></a> </li> <li> <a href="/anionu"><b>Anionu</b><small>Cloud video surveillance</small></a> </li> <li> <a href="//stompstart.com"><b>StompStart</b><small>Promote your startup</small></a> </li> <li> <a href="/symple"><b>Symple</b><small>Messaging made Symple</small></a> </li> <li> <a href="/mesh"><b>Mesh</b><small>Elegant, modern design</small></a> </li> <li> <a href="/pacm"><b>Pacm</b><small>Redistributable package manager</small></a> </li> <li> <a href="/pluga"><b>Pluga</b><small>C++ plugin system</small></a> </li> <li> <a href="//avidsense.com"><b>Avid Sense</b><small>Freedom of expression</small></a> </li> <li> <a href="/recliner"><b>Recliner.js</b><small>Flexible lazy loading</small></a> </li> </ul> </li> <li class=has-dropdown><a href="/#articles">Articles</a> <ul class=dropdown> <li><a href="/archives">Archives</a></li> <li><a href="/feed.xml">Feed</a></li> </ul> </li> <li><a href="mailto:hello@sourcey.com">Contact</a></li> <li class=divider></li> </ul> </section> </div> </nav> <header id=header> <h1 id=logo> <a title=Sourcey rel=home href="//sourcey.com"><img height=150 width=150 title=Sourcey alt=Sourcey src="/images/logos/sourcey-glow-250x250.png"/></a> </h1> </header> <div id=main role=main> <article> <header class=article-header> <h1>Building a Complete Rails 5 API Guide</h1> <div class=meta> By <a rel="author external" href="https://plus.google.com/+KamLow">Kam Low</a> &diams; <time class=updated datetime="Dec 26 2015">Dec 26 2015</time> </div> </header> <div class="article-wrap row"> <div class="large-8 columns"> <div class=content> <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd"> <html><body> <p>Thanks to the new <code>rails-api</code> gem that ships as part of the Rails 5 core, Rails is now an ideal candidate for building streamlined APIs quickly and easily.</p> <p>Until now, the best option for creating simple APIs in Ruby has arguably been Grape, and while Grape is still a fantastic option (especially if you like to DIY), there are some great advantages to using Rails 5 in API mode, such as; ActiveRecord by default, a strong developer community, and having the asset pipeline and front end features available should you need them later as your project evolves.</p> <h2 id=setting-up-rails-5>Setting up Rails 5</h2> <p>To install Rails in API mode all you need to do is pass the <code>--api</code> option at the command line when creating a new Rails app, and you will get a Rails API only app without any of the incumbent front end bloat, and all the inherent Railsy goodness.</p> <p>First, make sure you are running Ruby 2.2.2+ or newer as it’s required by Rails 5.</p> <p>According to the <a href="//edgeguides.rubyonrails.org/api_app.html">Rails guide</a> you will be able to generate an API app using the following command:</p> <p><code>bash rails new api_app_name --api </code></p> <p>However as Rails 5 isn’t officially released yet so we have to generate our Rails API app using the latest version. Simply clone the master branch from the Rails repo:</p> <p><code>bash git clone git@github.com:rails/rails.git </code></p> <p>Now we generate new Rails API application by passing the <code>--api</code> directive to the rails new command:</p> <p><code>bash bundle exec railties/exe/rails new &lt;parent-folder-path&gt;/api_app_name --api --edge </code></p> <p>Nice! Now you have a shiny new API only Rails 5 project to play with.</p> <p>The next thing is to run <code>bundle</code> and <code>rake</code> to install the default gems and setup the database:</p> <p><code>bash cd &lt;parent-folder-path&gt;/api_app_name bundle install bin/rake db:setup </code></p> <h2 id=using-rspec-for-testing>Using RSpec For Testing</h2> <p>Let’s setup RSpec for testing your application before we start generating any resources. To do this, go ahead and add the <a href="https://github.com/rspec/rspec-rails">rspec-rails</a> gem to your Gemfile in the <code>:development, :test</code> group:</p> <p>```ruby group :development, :test do</p> <p># Use RSpec for specs gem ‘rspec-rails’, ‘3.1.0’</p> <p># Use Factory Girl for generating random test data gem ‘factory_girl_rails’ end ```</p> <p>Update your bundle:</p> <p><code>bash bundle </code></p> <p>Run the RSpec installer:</p> <p><code>bash bin/rails g rspec:install </code></p> <p>Finally, you can get rid of the <code>test</code> directory in Rails, since we won’t be writing unit tests, but specifications instead.</p> <h2 id=bulding-your-api>Bulding Your API</h2> <p>With all the basic dependencies installed, lets start building out our API controllers.</p> <p>When an app is created with the <code>--api</code> flag you can use the scaffold generators to generate your API resources as normal, without the need for any special arguments.</p> <p><code>bash bin/rails g scaffold user name email </code></p> <p>This will generate the following file structure:</p> <p>```bash invoke active_record identical db/migrate/20151222022044_create_users.rb identical app/models/user.rb invoke rspec create spec/models/user_spec.rb invoke factory_girl create spec/factories/users.rb invoke resource_route route resources :users invoke scaffold_controller identical app/controllers/users_controller.rb invoke rspec create spec/controllers/users_controller_spec.rb create spec/routing/users_routing_spec.rb invoke rspec create spec/requests/users_spec.rb</p> <p>```</p> <p>Now all that’s left is to migrate and run the app:</p> <p>```bash bin/rake db:migrate</p> <h1 id=run-the-default-server-on-port-3000>run the default server on port 3000</h1> <p>bin/rails s ```</p> <p>Your new API is now up and running on <a href="//localhost:3000">http://localhost:3000</a>. Sweet!</p> <p>You’re not done yet though, there are still a bunch of important points for consideration…</p> <h2 id=serializing-api-output>Serializing API Output</h2> <p>In it’s current state our app will just spit out every column in the database in JSON format, so we need a way to control what data gets served through the API.</p> <p>Usually we would use a front end templating engines such as <code>jbuilder</code> for this purpose, but since we’ve disabled views in our super awesome streamlined API app, that’s not going to be an option.</p> <p>Fortunately there’s an ideal solution using AMS (Active Model Serializers) via the <a href="https://github.com/rails-api/active_model_serializers">active_model_serializers</a> gem.</p> <p>Go ahead and add the <code>active_model_serializers</code> dependency to your Gemfile:</p> <p><code>ruby gem 'active_model_serializers' </code></p> <p>Update your bundle:</p> <p><code>bash bundle </code></p> <p>Now lets create a serializer for our User model:</p> <p><code>bash rails g serializer user </code></p> <p>In <code>app/serializers/user_serializer.rb</code>, we find this code:</p> <p><code>ruby class UserSerializer &lt; ActiveModel::Serializer attributes :id end </code></p> <p>Go ahead and add the <code>:name</code> and <code>:email</code> attributes to the serializer:</p> <p><code>ruby class UserSerializer &lt; ActiveModel::Serializer attributes :id, :name, :email end </code></p> <p class="panel callout radius">If your model has relationships just add them to the serializer as you would an attributes to be serialized in the output.</p> <p>You may also need to include the <code>ActionController::Serialization</code> dependency in your controller like so:</p> <p>```ruby class ApplicationController &lt; ActionController::API include ActionController::Serialization</p> <p># … end ```</p> <p>Now when you hit and User related API endpoint only the attributes in the <code>UserSerializer</code> will be rendered. Nice!</p> <h2 id=enabling-cors>Enabling CORS</h2> <p>If you’re building a public API you’ll probably want to enable Cross-Origin Resource Sharing (CORS), in order to make cross-origin AJAX requests possible.</p> <p>This is made very simple by the <code>rack-cors</code> gem. Just stick it in your Gemfile like so:</p> <p><code>ruby gem 'rack-cors' </code></p> <p>Update your bundle:</p> <p><code>bash bundle </code></p> <p>And put something like the code below in <code>config/application.rb</code> of your Rails application. For example, this will allow GET, POST or OPTIONS requests from any origin on any resource.</p> <p>```ruby module YourApp class Application &lt; Rails::Application</p> <pre class="highlight plaintext"><code># ...

config.middleware.insert_before 0, "Rack::Cors" do
  allow do
    origins '*'
    resource '*', :headers =&gt; :any, :methods =&gt; [:get, :post, :options]
  end
end
</code></pre> <p>end end ```</p> <p>For more detailed configuration options please see the gem documentation: https://github.com/cyu/rack-cors</p> <h2 id=versioning-your-api>Versioning your API</h2> <p>Before releasing your public API into the wild, you should consider implementing some form of versioning. Versioning breaks your API up into multiple version namespaces, such as <code>v1</code> and <code>v2</code>, so that you can maintain backwards compatibility for existing clients whenever you introduce breaking changes into your API, simply by incrementing your API version.</p> <p>This guide will show you how to setup versioning with the following URL format:</p> <p><code> GET http://api.mysite.com/v1/users/ </code></p> <p>Using a subdomain instead of something like <code>/api/v1/users/</code> is just a preference, although both are easy to accomplish in Rails.</p> <p>We can use a directory structure like this to keep our controller code clean by defining all our <code>v1</code> controllers within the <code>Api::V1</code> namespace:</p> <p><code> app/controllers/ . |-- api | `-- v1 | |-- api_controller.rb | `-- users_controller.rb |-- application_controller.rb </code></p> <p>Here’s what the controllers look like:</p> <p>```ruby # app/controllers/api/v1/api_controller.rb</p> <p>module Api::V1 class ApiController &lt; ApplicationController # Generic API stuff here end end ```</p> <p>```ruby # app/controllers/api/v1/users_controller.rb</p> <p>module Api::V1 class UsersController &lt; ApiController</p> <pre class="highlight plaintext"><code># GET /v1/users
def index
  render json: User.all
end
</code></pre> <p>end end ```</p> <p>Now let’s setup our <code>config/routes.rb</code> to tie everything together:</p> <p><code>ruby constraints subdomain: 'api' do scope module: 'api' do namespace :v1 do resources :users end end end </code></p> <p>The <code>scope module: 'api'</code> bit lets us route to controllers in the API module without explicitly including it in the URL. However, the version <code>v1/</code> is part of the URL, and we also want to route to the V1 module, so we use <code>namespace</code>.</p> <p>Now you’re API routes are looking pretty sharp!</p> <h2 id=rate-limiting-and-throttling>Rate Limiting and Throttling</h2> <p>To protect our API from DDoS, brute force attacks, hammering, or even to monetize with paid usage limits, we can use a Rake <a href="//guides.rubyonrails.org/rails_on_rack.html">middleware</a> called <code>Rack::Attack</code>. The <a href="https://github.com/kickstarter/rack-attack">rack-attack</a> gem was released by Kickstarter, and it allows us to:</p> <ul> <li>whitelist: Allowing it to process normally if certain conditions are true</li> <li>blacklist: Sending a denied message instantly for certain requests</li> <li>throttle: Checking if the user is within their allowed usage</li> <li>track: Tracking this request to be able to log certain information about our requests</li> </ul> <p>Get started by adding the dependency to your Gemfile:</p> <p><code>ruby gem 'rack-attack' </code></p> <p>Update your bundle:</p> <p><code>bash bundle </code></p> <p>Now update your <code>config/application.rb</code> file to include it into your middleware stack:</p> <p>```ruby module YourApp class Application &lt; Rails::Application</p> <pre class="highlight plaintext"><code># ...

config.middleware.use Rack::Attack
</code></pre> <p>end end ```</p> <p>Create a new initializer file in <code>config/initializers/rack_attack.rb</code> to configure your <code>Rack::Attack</code> rules. The example below is very basic, and you might have different requirements altogether, but it should give a good starting point.</p> <p>```ruby class Rack::Attack</p> <p># <code>Rack::Attack</code> is configured to use the <code>Rails.cache</code> value by default, # but you can override that by setting the <code>Rack::Attack.cache.store</code> value Rack::Attack.cache.store = ActiveSupport::Cache::MemoryStore.new</p> <p># Allow all local traffic whitelist(‘allow-localhost’) do |req| ‘127.0.0.1’ == req.ip || ‘::1’ == req.ip end</p> <p># Allow an IP address to make 5 requests every 5 seconds throttle(‘req/ip’, limit: 5, period: 5) do |req| req.ip end</p> <p># Send the following response to throttled clients self.throttled_response = -&gt;(env) { retry_after = (env[‘rack.attack.match_data’] || {})[:period] [ 429, {‘Content-Type’ =&gt; ‘application/json’, ‘Retry-After’ =&gt; retry_after.to_s}, [{error: “Throttle limit reached. Retry later.”}.to_json] ] } end ```</p> <p>For a full list of configuration options check the <a href="https://github.com/kickstarter/rack-attack">Rack::Attack</a> gem homepage.</p> <p>Now that our API is safe from brute force attacks we can sleep a little better at night!</p> <h2 id=authenticating-your-api>Authenticating Your API</h2> <p>Let’s lock our API down with some authentication.</p> <p>As a rule API’s should be stateless, and therefore should not have any knowledge of cookies or sessions.</p> <p class="panel callout radius">If you require sessions then you should be looking at implementing some form of <a href="//oauth.net/2">OAuth</a> based authentication, but that won’t be covered in this guide.</p> <p>A good way of authenticating API requests is using token based authentication, which involves clients including a API key of some sort in the HTTP headers of each request, like so:</p> <p><code> Authorization: Token token="WCZZYjnOQFUYfJIN2ShH1iD24UHo58A6TI" </code></p> <p>First let’s update create a migration to add the <code>api_key</code> attribute to our <code>User</code> model:</p> <p><code>ruby rails g migration AddApiKeyToUsers api_key:string </code></p> <p>Now update the <code>User</code> model and include the following methods:</p> <p>```ruby class User &lt; ActiveRecord::Base</p> <p># Assign an API key on create before_create do |user| user.api_key = user.generate_api_key end</p> <p># Generate a unique API key def generate_api_key loop do token = SecureRandom.base64.tr(‘+/=’, ‘Qrt’) break token unless User.exists?(api_key: token).any? end end end ```</p> <p>On the controller side we can implement the authentication using the built in <code>authenticate_or_request_with_http_token</code> Rails method.</p> <p>```ruby class Api::ApiController &lt; ActionController::Base</p> <p># Add a before_action to authenticate all requests. # Move this to subclassed controllers if you only # want to authenticate certain methods. before_action :authenticate</p> <p># Expose <code>current_user</code> to subclassed controllers helper_method :current_user</p> <p>private</p> <p># Authenticate the user with token based authentication def authenticate authenticate_or_request_with_http_token do |token, options| @current_user = User.where(api_key: token).first end end end ```</p> <p>Now we can test our authenticated API using <code>curl</code>:</p> <p><code>bash curl -H "Authorization: Token token=PsmmvKBqQDOaWwEsPpOCYMsy" http://localhost:3000/users </code></p> <h2 id=conclusion>Conclusion</h2> <p>Now you have the keys to the castle, and all the basics for building an API the Rails way.</p> <p>Hopefully then guide was helpful for you, and if you want any points clarified or just want to say thanks then please use the comments below.</p> <p>Cheers, and happy coding!</p> </body></html> </div> </div> <div class="large-4 columns"> <div class=sidebar> <div class="sidebar-section tags"> <h4>Tags</h4> <ul><li><a href="/tags/rails/">Rails</a></li><li><a href="/tags/api/">API</a></li></ul> </div> <div class="sidebar-section ad ad-300x250 sidebar-float"> <ins class=adsbygoogle style="display:inline-block;width:300px;height:600px" data-ad-client=ca-pub-1397369873900370 data-ad-slot=7510590887></ins> <script>
                (adsbygoogle = window.adsbygoogle || []).push({});
                </script> </div> </div> </div> </article> <div class=row> <div class=social-buttons> <ul> <li> <a href="//twitter.com/share" class="socialite twitter-share" data-text="Building a Complete Rails 5 API Guide" data-url="http://sourcey.com/building-a-complete-rails-5-api-guide/" data-count=vertical rel=nofollow target=_blank><span class=vhidden>Share on Twitter</span></a> </li> <li> <a href="https://plus.google.com/share?url=http://sourcey.com/building-a-complete-rails-5-api-guide/" class="socialite googleplus-one" data-size=tall data-href="//sourcey.com/building-a-complete-rails-5-api-guide/" rel=nofollow target=_blank><span class=vhidden>Share on Google+</span></a> </li> <li> <a href="//www.facebook.com/sharer.php?u=http://sourcey.com/building-a-complete-rails-5-api-guide/&amp;t=Building a Complete Rails 5 API Guide" class="socialite facebook-like" data-href="http://sourcey.com/building-a-complete-rails-5-api-guide/" data-send=false data-layout=box_count data-width=60 data-show-faces=false rel=nofollow target=_blank><span class=vhidden>Share on Facebook</span></a> </li> <li> <a href="//www.linkedin.com/shareArticle?mini=true&amp;url=http://sourcey.com/building-a-complete-rails-5-api-guide/&amp;title=Building a Complete Rails 5 API Guide" class="socialite linkedin-share" data-url="http://sourcey.com/building-a-complete-rails-5-api-guide/" data-counter=top rel=nofollow target=_blank><span class=vhidden>Share on LinkedIn</span></a> </li> </ul> </div> </div> <div id=disqus_thread></div> <script>
          /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
          var disqus_shortname = 'sourcey'; // required: replace example with your forum shortname

          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
              var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
              dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
              (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
      </script> <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript" rel=nofollow>comments powered by Disqus.</a></noscript> <a href="//disqus.com" rel=nofollow class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a> </div> <footer id=footer> <div class="row show-for-large-up"> <div class="ad ad-720x90 text-center"> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <ins class=adsbygoogle style="display:inline-block;width:728px;height:90px" data-ad-client=ca-pub-1397369873900370 data-ad-slot=8042301285></ins> <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
          </script> </div> </div> <p> As with all business minded artists, we have fought the inevitable battle of conformity vs expression, and have emerged victorious with sanity intact to plunder the digiverse in search of new and interesting challenges. For more information, or a quote, drop us an email and tell us what you're working on. </p> <p>&copy; 2016 Sourcey<p> </footer> </body> </html>